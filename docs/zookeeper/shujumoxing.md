ZooKeeper 中的数据模型是一种树形结构，非常像电脑中的文件系统，有一个根文件夹，下面还有很多子文件夹。

*   ZooKeeper的数据模型也具有一个固定的根节点`（/）`，我们可以在根节点下创建子节点，并在子节点下继续创建下一级节点。

*   ZooKeeper 树中的每一层级用斜杠`（/）`分隔开，且只能用绝对路径（如`get /work/task`）的方式查询 ZooKeeper 节点，而不能使用相对路径。

![](https://cdn.jsdelivr.net/gh/itwanger/toBeBetterJavaer/images/zookeeper/shujumoxing-1.png)

**「为什么 ZooKeeper 不能采用相对路径查找节点呢？」**

> ❝
> 
> 这是因为 ZooKeeper 大多是应用场景是定位数据模型上的节点，并在相关节点上进行操作。
> 
> ❞

像这种查找与给定值相等的记录问题最适合用散列来解决。

因此 ZooKeeper 在底层实现的时候，使用了一个 hashtable，即 `hashtableConcurrentHashMap<String, DataNode> nodes`，用节点的完整路径来作为 key 存储节点数据。

这样就大大提高了 ZooKeeper 的性能。

**「节点类型」**

ZooKeeper 中的数据节点也分为持久节点、临时节点和有序节点三种类型：

> ❝
> 
> 1、持久节点
> 
> ❞

一旦将节点创建为持久节点，该数据节点会一直存储在 ZooKeeper 服务器上，即使创建该节点的客户端与服务端的会话关闭了，该节点依然不会被删除。如果我们想删除持久节点，就要显式调用 delete 函数进行删除操作。

> ❝
> 
> 2、临时节点
> 
> ❞

如果将节点创建为临时节点，那么该节点数据不会一直存储在 ZooKeeper 服务器上。

当创建该临时节点的客户端会话因超时或发生异常而关闭时，该节点也相应在 ZooKeeper 服务器上被删除，同样，我们可以像删除持久节点一样主动删除临时节点。

在平时的开发中，我们可以利用临时节点的这一特性来做服务器集群内机器运行情况的统计，将集群设置为`/servers`节点，并为集群下的每台服务器创建一个临时节点`/servers/host`，当服务器下线时该节点自动被删除，最后统计临时节点个数就可以知道集群中的运行情况。

> ❝
> 
> 3、有序节点
> 
> ❞

节点有序是说在我们创建有序节点的时候，ZooKeeper 服务器会自动使用一个单调递增的数字作为后缀，追加到我们创建节点的后边。

例如一个客户端创建了一个路径为 `works/task-`的有序节点，那么 ZooKeeper 将会生成一个序号并追加到该节点的路径后，最后该节点的路径为`works/task-1`。

*   通过这种方式我们可以直观的查看到节点的创建顺序。

ZooKeeper 中的每个节点都维护有这些内容：一个二进制数组`（byte data[]）`，用来存储节点的数据、ACL 访问控制信息、子节点数据（因为临时节点不允许有子节点，所以其子节点字段为 null），除此之外每个数据节点还有一个记录自身状态信息的字段 stat。

**「节点的状态结构」**

执行`stat /zk_test`，可以看到控制台输出了一些信息，这些就是节点状态信息。

每一个节点都有一个自己的状态属性，记录了节点本身的一些信息：

| **「状态属性」** | **「说明」** |
| --- | --- |
| czxid | 数据节点创建时的事务 ID |
| ctime | 数据节点创建时的时间 |
| mzxid | 数据节点最后一次更新时的事务 ID |
| mtime | 数据节点最后一次更新时的时间 |
| pzxid | 数据节点的子节点最后一次被修改时的事务 ID |
| **「cversion」** | **「子节点的版本」** |
| **「version」** | **「当前节点数据的版本」** |
| **「aversion」** | **「节点的 ACL 的版本」** |
| ephemeralOwner | 如果节点是临时节点，则表示创建该节点的会话的 SessionID；如果节点是持久节点，则该属性值为 0 |
| dataLength | 数据内容的长度 |
| numChildren | 数据节点当前的子节点个数 |

**「数据节点的版本」**

在 ZooKeeper 中为数据节点引入了版本的概念，每个数据节点有 3 种类型的版本信息，对数据节点的任何更新操作都会引起版本号的变化。

ZooKeeper 的版本信息表示的是对节点数据内容、子节点信息或者是 ACL 信息的修改次数。

整理：沉默王二，戳[转载链接](https://mp.weixin.qq.com/s/-evZg0epRrOr1IwQ3GJ2Zg)，作者：月伴飞鱼，戳[原文链接](https://mp.weixin.qq.com/s/B2ngp0q5kdWsCNH8sw_5DA)。
